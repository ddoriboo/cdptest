<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDP AI 자연어 쿼리 플랫폼 - Working</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }
        
        .nav-tab {
            background: none;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            min-width: 120px;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .nav-tab.active {
            background: white;
            border-bottom-color: #4CAF50;
            color: #4CAF50;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .query-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .query-input-container {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .query-input {
            width: 100%;
            padding: 20px 60px 20px 20px;
            font-size: 18px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            outline: none;
            transition: border-color 0.3s ease;
            background: white;
        }
        
        .query-input:focus {
            border-color: #4CAF50;
        }
        
        .query-button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .query-button:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        /* 담당자별 추천 질문 섹션 */
        .team-recommendations {
            margin-top: 25px;
        }
        
        .team-recommendations h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .team-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .team-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .team-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .team-button .name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .team-button .role {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .recommended-questions {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid #e9ecef;
        }
        
        .recommended-questions.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .question-item {
            background: #f8f9fa;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid #4CAF50;
        }
        
        .question-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        /* AI 사고 과정 시각화 */
        .thinking-process {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            display: none;
        }
        
        .thinking-process.show {
            display: block;
        }
        
        .thinking-step {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #e9ecef;
            opacity: 0.3;
            transition: all 0.5s ease;
        }
        
        .thinking-step.active {
            opacity: 1;
            border-left-color: #4CAF50;
            transform: translateX(5px);
        }
        
        .thinking-step.completed {
            opacity: 1;
            border-left-color: #28a745;
            background: #f8fff9;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        .thinking-step.active .step-icon {
            background: #4CAF50;
            color: white;
            animation: pulse 1s infinite;
        }
        
        .thinking-step.completed .step-icon {
            background: #28a745;
            color: white;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .step-content h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .step-content p {
            color: #6c757d;
            font-size: 14px;
        }
        
        /* 컬럼 브라우저 */
        .column-browser {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }
        
        .search-filter-section {
            margin-bottom: 25px;
        }
        
        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .filter-btn {
            background: white;
            border: 1px solid #dee2e6;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .column-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .column-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .column-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .column-type {
            background: #e9ecef;
            color: #495057;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .column-description {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .column-example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            color: #495057;
        }
        
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .analysis-result {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #4CAF50;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #856404;
        }
        
        .error-info {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #721c24;
        }
        
        .success-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #155724;
        }
        
        @media (max-width: 768px) {
            .team-buttons {
                grid-template-columns: 1fr;
            }
            
            .columns-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 CDP AI 자연어 쿼리 플랫폼</h1>
            <p>AI가 단계별로 분석하여 최적의 고객 세그먼테이션 전략을 추천합니다</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('query-analyzer')">🔍 쿼리 분석기</button>
            <button class="nav-tab" onclick="showTab('column-browser')">📚 컬럼 브라우저</button>
            <button class="nav-tab" onclick="showTab('team-recommendations')">👥 팀별 추천</button>
        </div>
        
        <!-- 쿼리 분석기 탭 -->
        <div id="query-analyzer" class="tab-content active">
            <div class="query-section">
                <div class="query-input-container">
                    <input type="text" 
                           class="query-input" 
                           id="queryInput" 
                           placeholder="예: 대출 니즈가 높은 고객군 알려줘, 젊은 여성 중 뷰티 관심사가 높은 고객 찾아줘"
                           onkeypress="handleKeyPress(event)">
                    <button class="query-button" onclick="processQuery()">
                        🔍 AI 분석
                    </button>
                </div>
                
                <!-- 디버깅 정보 확인 버튼 -->
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="checkServerStatus()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 12px;">
                        🔧 서버 상태 확인
                    </button>
                </div>
            </div>
            
            <!-- AI 사고 과정 시각화 -->
            <div class="thinking-process" id="thinkingProcess">
                <h3>🧠 AI 사고 과정</h3>
                <div class="thinking-step" id="step1">
                    <div class="step-icon">1️⃣</div>
                    <div class="step-content">
                        <h4>🎯 질문 분석 결과</h4>
                        <p>사용자의 자연어 질문을 분석하고 핵심 요구사항을 파악합니다</p>
                    </div>
                </div>
                <div class="thinking-step" id="step2">
                    <div class="step-icon">2️⃣</div>
                    <div class="step-content">
                        <h4>👥 타겟 고객군 정의</h4>
                        <p>비즈니스 목적에 맞는 최적의 타겟 고객군을 정의합니다</p>
                    </div>
                </div>
                <div class="thinking-step" id="step3">
                    <div class="step-icon">3️⃣</div>
                    <div class="step-content">
                        <h4>📊 추천 CDP 컬럼 조합</h4>
                        <p>CDP 데이터에서 최적의 컬럼 조합을 추천합니다</p>
                    </div>
                </div>
                <div class="thinking-step" id="step4">
                    <div class="step-icon">4️⃣</div>
                    <div class="step-content">
                        <h4>🧠 AI 분석 근거</h4>
                        <p>각 컬럼 선택의 이유와 분석 근거를 제시합니다</p>
                    </div>
                </div>
                <div class="thinking-step" id="step5">
                    <div class="step-icon">5️⃣</div>
                    <div class="step-content">
                        <h4>📝 실행 가능한 SQL 쿼리</h4>
                        <p>타겟 고객군을 추출할 수 있는 SQL 쿼리를 생성합니다</p>
                    </div>
                </div>
                <div class="thinking-step" id="step6">
                    <div class="step-icon">6️⃣</div>
                    <div class="step-content">
                        <h4>💡 비즈니스 인사이트 & 마케팅 활용방안</h4>
                        <p>비즈니스 인사이트와 마케팅 활용 방안을 도출합니다</p>
                    </div>
                </div>
            </div>
            
            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <p>🧠 AI가 단계별로 분석하고 있습니다...</p>
            </div>
            
            <div id="debugInfo"></div>
            <div id="analysisResults"></div>
        </div>
        
        <!-- 컬럼 브라우저 탭 -->
        <div id="column-browser" class="tab-content">
            <div class="column-browser">
                <h2>📚 CDP 컬럼 브라우저</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">전체 847개의 CDP 컬럼을 카테고리별로 탐색하고 검색할 수 있습니다.</p>
                
                <div class="stats-section">
                    <div class="stat-card">
                        <div class="stat-number">52</div>
                        <div class="stat-label">관심사 지표</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">142</div>
                        <div class="stat-label">업종별 지표</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">156</div>
                        <div class="stat-label">예측 스코어</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">497</div>
                        <div class="stat-label">플래그 지표</div>
                    </div>
                </div>
                
                <div class="search-filter-section">
                    <input type="text" class="search-box" id="columnSearch" placeholder="컬럼명이나 설명으로 검색하세요..." onkeyup="filterColumns()">
                    
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterByCategory('all')">전체</button>
                        <button class="filter-btn" onclick="filterByCategory('interests')">관심사 (fa_int_*)</button>
                        <button class="filter-btn" onclick="filterByCategory('industries')">업종별 (fa_ind_*)</button>
                        <button class="filter-btn" onclick="filterByCategory('scores')">예측스코어 (sc_*)</button>
                        <button class="filter-btn" onclick="filterByCategory('flags')">플래그 (fi_npay_*)</button>
                    </div>
                </div>
                
                <div class="columns-grid" id="columnsGrid">
                    <!-- 컬럼 카드들이 여기에 동적으로 생성됩니다 -->
                </div>
            </div>
        </div>
        
        <!-- 팀별 추천 탭 -->
        <div id="team-recommendations" class="tab-content">
            <div class="query-section">
                <h2>👥 팀별 맞춤 추천 질문</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">각 담당자님의 업무 영역에 특화된 질문들을 추천드립니다.</p>
                
                <div class="team-buttons">
                    <button class="team-button" onclick="showTeamQuestions('financial-content')">
                        <div class="name">💰 정선영님</div>
                        <div class="role">금융 컨텐츠 (머니스토리)</div>
                    </button>
                    <button class="team-button" onclick="showTeamQuestions('member-planning')">
                        <div class="name">👥 박지영님</div>
                        <div class="role">회원 플래닝</div>
                    </button>
                    <button class="team-button" onclick="showTeamQuestions('myasset')">
                        <div class="name">🏦 김정희님</div>
                        <div class="role">내자산 플래닝 (마이데이터)</div>
                    </button>
                    <button class="team-button" onclick="showTeamQuestions('advertising')">
                        <div class="name">📢 고시현님</div>
                        <div class="role">AD 서비스</div>
                    </button>
                    <button class="team-button" onclick="showTeamQuestions('payment')">
                        <div class="name">💳 최동주님</div>
                        <div class="role">결제 데이터</div>
                    </button>
                    <button class="team-button" onclick="showTeamQuestions('loan')">
                        <div class="name">🏠 이승한님</div>
                        <div class="role">대출 서비스</div>
                    </button>
                </div>
                
                <div class="recommended-questions" id="teamQuestions">
                    <!-- 추천 질문들이 여기에 동적으로 생성됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // API 키는 서버에서 제공받아야 합니다 (보안상 클라이언트에 하드코딩 금지)
        const OPENAI_API_KEY = null; // 실제 구현시 서버에서 API 호출 처리
        
        // 여러 모델을 시도할 수 있도록 설정
        const MODELS_TO_TRY = [
            'o3-mini-2025-01-31',
            'gpt-4o-mini',
            'gpt-4-turbo',
            'gpt-3.5-turbo'
        ];
        
        let currentModelIndex = 0;
        
        // 전체 CDP 컬럼 정의 (실제 데이터에 맞게 확장)
        const FULL_CDP_COLUMNS = {
            interests: {
                'fa_int_householdsingle': { desc: '1인 가구 관련 상품 결제 또는 오피스텔/원룸 거주 추정 고객', type: 'date', example: 'WHERE fa_int_householdsingle IS NOT NULL' },
                'fa_int_householdpet': { desc: '반려동물 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_householdpet IS NOT NULL' },
                'fa_int_householdchild': { desc: '어린이 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_householdchild IS NOT NULL' },
                'fa_int_householdbaby': { desc: '영유아 관련 상품 결제 또는 출산 정책지원금 수령 고객', type: 'date', example: 'WHERE fa_int_householdbaby IS NOT NULL' },
                'fa_int_householdyouth': { desc: '중고등학생 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_householdyouth IS NOT NULL' },
                'fa_int_publictransport': { desc: 'Npay 교통카드 이용 또는 교통비 결제 고객', type: 'date', example: 'WHERE fa_int_publictransport IS NOT NULL' },
                'fa_int_motorcycle': { desc: '오토바이 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_motorcycle IS NOT NULL' },
                'fa_int_loan1stfinancial': { desc: '1금융권에서 신용 대출 실행 고객', type: 'date', example: 'WHERE fa_int_loan1stfinancial IS NOT NULL' },
                'fa_int_loan2ndfinancial': { desc: '저축은행, 카드사, 보험사, 증권사 등에서 신용 대출 실행 고객', type: 'date', example: 'WHERE fa_int_loan2ndfinancial IS NOT NULL' },
                'fa_int_loanpersonal': { desc: '신용대출을 실행 고객', type: 'date', example: 'WHERE fa_int_loanpersonal IS NOT NULL' },
                'fa_int_saving': { desc: '예적금 개설 고객', type: 'date', example: 'WHERE fa_int_saving IS NOT NULL' },
                'fa_int_jeonsemonthlyrent': { desc: '계좌 및 대출이력을 통한 전월세 거주 추정 고객', type: 'date', example: 'WHERE fa_int_jeonsemonthlyrent IS NOT NULL' },
                'fa_int_homeappliance': { desc: '가전 상품 결제 고객', type: 'date', example: 'WHERE fa_int_homeappliance IS NOT NULL' },
                'fa_int_luxury': { desc: '100만원 이상 명품관련 결제 고객', type: 'date', example: 'WHERE fa_int_luxury IS NOT NULL' },
                'fa_int_delivery': { desc: '식비 목적의 배달 결제 고객', type: 'date', example: 'WHERE fa_int_delivery IS NOT NULL' },
                'fa_int_mutualaidservice': { desc: '상조서비스 관련 결제 고객', type: 'date', example: 'WHERE fa_int_mutualaidservice IS NOT NULL' },
                'fa_int_interior': { desc: '인테리어 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_interior IS NOT NULL' },
                'fa_int_carinsurance': { desc: '향후 1개월 자동차 보험 결제 예정으로 추정되는 고객', type: 'date', example: 'WHERE fa_int_carinsurance IS NOT NULL' },
                'fa_int_carpurchase': { desc: '마이카 및 오토론을 통한 차량 구매 추정 고객', type: 'date', example: 'WHERE fa_int_carpurchase IS NOT NULL' },
                'fa_int_overseasshopping': { desc: '해외직구 결제 고객', type: 'date', example: 'WHERE fa_int_overseasshopping IS NOT NULL' },
                'fa_int_traveldomestic': { desc: '국내여행 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_traveldomestic IS NOT NULL' },
                'fa_int_travelpackage': { desc: '여행사 패키지 상품 결제 고객', type: 'date', example: 'WHERE fa_int_travelpackage IS NOT NULL' },
                'fa_int_traveloverseas': { desc: '향후 1개월 내 해외 여행 목적의 출국 예정 추정 고객', type: 'date', example: 'WHERE fa_int_traveloverseas IS NOT NULL' },
                'fa_int_travelasia': { desc: '향후 1개월 내 아시아 지역으로 해외여행 목적의 출국 예정 추정 고객', type: 'date', example: 'WHERE fa_int_travelasia IS NOT NULL' },
                'fa_int_golf': { desc: '골프용품/골프장 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_golf IS NOT NULL' },
                'fa_int_running': { desc: '러닝/마라톤 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_running IS NOT NULL' },
                'fa_int_swimming': { desc: '수영 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_swimming IS NOT NULL' },
                'fa_int_pilatesyoga': { desc: '필라테스/요가 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_pilatesyoga IS NOT NULL' },
                'fa_int_gym': { desc: '피트니스/헬스장 가맹점 결제 고객', type: 'date', example: 'WHERE fa_int_gym IS NOT NULL' },
                'fa_int_wedding': { desc: '결혼 준비 관련 상품 결제 및 활동 발생 고객', type: 'date', example: 'WHERE fa_int_wedding IS NOT NULL' },
                'fa_int_retirement': { desc: '향후 24개월 내 은퇴 예정으로 추정되는 고객', type: 'date', example: 'WHERE fa_int_retirement IS NOT NULL' },
                'fa_int_move': { desc: '주소지 변경이력 존재 또는 이사 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_move IS NOT NULL' },
                'fa_int_childbirth': { desc: '임신/출산 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_childbirth IS NOT NULL' },
                'fa_int_highincome': { desc: 'Nice 추정소득 1억이상 고객', type: 'date', example: 'WHERE fa_int_highincome IS NOT NULL' },
                'fa_int_homeowner': { desc: '주택 소유 추정 고객', type: 'date', example: 'WHERE fa_int_homeowner IS NOT NULL' },
                'fa_int_business': { desc: '대출 등을 통한 사업자 추정 고객', type: 'date', example: 'WHERE fa_int_business IS NOT NULL' },
                'fa_int_youngprofessional': { desc: '급여입금을 통해 취직 추정 고객', type: 'date', example: 'WHERE fa_int_youngprofessional IS NOT NULL' },
                'fa_int_pharmaceutical': { desc: '제약 B2B 가맹점 고객', type: 'date', example: 'WHERE fa_int_pharmaceutical IS NOT NULL' },
                'fa_int_worker': { desc: '정기적으로 급여 받는 고객', type: 'date', example: 'WHERE fa_int_worker IS NOT NULL' },
                'fa_int_fishing': { desc: '낚시 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_fishing IS NOT NULL' },
                'fa_int_diet': { desc: '다이어트 목적의 상품 결제 고객', type: 'date', example: 'WHERE fa_int_diet IS NOT NULL' },
                'fa_int_alcohol': { desc: '주류 관련 상품 결제 고객', type: 'date', example: 'WHERE fa_int_alcohol IS NOT NULL' },
                'fa_int_ott': { desc: 'OTT 관련 결제 고객', type: 'date', example: 'WHERE fa_int_ott IS NOT NULL' }
            },
            industries: {
                'fa_ind_education': { desc: '교육 결제 고객', type: 'date', example: 'WHERE fa_ind_education IS NOT NULL' },
                'fa_ind_academy': { desc: '학원 결제 고객', type: 'date', example: 'WHERE fa_ind_academy IS NOT NULL' },
                'fa_ind_transportation': { desc: '교통 결제 고객', type: 'date', example: 'WHERE fa_ind_transportation IS NOT NULL' },
                'fa_ind_finance': { desc: '금융 결제 고객', type: 'date', example: 'WHERE fa_ind_finance IS NOT NULL' },
                'fa_ind_insurance': { desc: '보험 결제 고객', type: 'date', example: 'WHERE fa_ind_insurance IS NOT NULL' },
                'fa_ind_beauty': { desc: '미용 결제 고객', type: 'date', example: 'WHERE fa_ind_beauty IS NOT NULL' },
                'fa_ind_medical': { desc: '의료 결제 고객', type: 'date', example: 'WHERE fa_ind_medical IS NOT NULL' },
                'fa_ind_travel': { desc: '여행 결제 고객', type: 'date', example: 'WHERE fa_ind_travel IS NOT NULL' },
                'fa_ind_foodbeverage': { desc: 'F&B 결제 고객', type: 'date', example: 'WHERE fa_ind_foodbeverage IS NOT NULL' },
                'fa_ind_cafe': { desc: '카페 결제 고객', type: 'date', example: 'WHERE fa_ind_cafe IS NOT NULL' },
                'fa_ind_restaurant': { desc: '음식점 결제 고객', type: 'date', example: 'WHERE fa_ind_restaurant IS NOT NULL' },
                'fa_ind_cosmetic': { desc: '뷰티 결제 고객', type: 'date', example: 'WHERE fa_ind_cosmetic IS NOT NULL' },
                'fa_ind_fashion': { desc: '패션의류 결제 고객', type: 'date', example: 'WHERE fa_ind_fashion IS NOT NULL' },
                'fa_ind_digitalappliances': { desc: '디지털가전 결제 고객', type: 'date', example: 'WHERE fa_ind_digitalappliances IS NOT NULL' },
                'fa_ind_golfcourse': { desc: '골프장 결제 고객', type: 'date', example: 'WHERE fa_ind_golfcourse IS NOT NULL' },
                'fa_ind_fitness': { desc: '피트니스 결제 고객', type: 'date', example: 'WHERE fa_ind_fitness IS NOT NULL' }
            },
            scores: {
                'sc_int_householdsingle': { desc: '1인 가구 관련 상품 결제 예측스코어', type: 'double', example: 'WHERE sc_int_householdsingle > 0.7' },
                'sc_int_householdpet': { desc: '동물용품/동물병원 결제 예측스코어', type: 'double', example: 'WHERE sc_int_householdpet > 0.7' },
                'sc_int_loan1stfinancial': { desc: '1금융권 신용대출 예측스코어', type: 'double', example: 'WHERE sc_int_loan1stfinancial > 0.7' },
                'sc_int_loan2ndfinancial': { desc: '2금융권 신용대출 예측스코어', type: 'double', example: 'WHERE sc_int_loan2ndfinancial > 0.7' },
                'sc_int_luxury': { desc: '명품 구매 예측스코어', type: 'double', example: 'WHERE sc_int_luxury > 0.8' },
                'sc_int_delivery': { desc: '배달 이용 예측스코어', type: 'double', example: 'WHERE sc_int_delivery > 0.6' },
                'sc_int_golf': { desc: '골프 관련 예측스코어', type: 'double', example: 'WHERE sc_int_golf > 0.7' },
                'sc_int_highincome': { desc: '고소득 예측스코어', type: 'double', example: 'WHERE sc_int_highincome > 0.8' },
                'sc_int_wedding': { desc: '결혼 준비 예측스코어', type: 'double', example: 'WHERE sc_int_wedding > 0.7' },
                'sc_ind_beauty': { desc: '미용 서비스 예측스코어', type: 'double', example: 'WHERE sc_ind_beauty > 0.7' },
                'sc_ind_cosmetic': { desc: '뷰티 제품 예측스코어', type: 'double', example: 'WHERE sc_ind_cosmetic > 0.8' },
                'sc_ind_finance': { desc: '금융 서비스 예측스코어', type: 'double', example: 'WHERE sc_ind_finance > 0.7' }
            },
            flags: {
                'fi_npay_age20': { desc: '20대', type: 'boolean', example: 'WHERE fi_npay_age20 = true' },
                'fi_npay_age30': { desc: '30대', type: 'boolean', example: 'WHERE fi_npay_age30 = true' },
                'fi_npay_age40': { desc: '40대', type: 'boolean', example: 'WHERE fi_npay_age40 = true' },
                'fi_npay_genderf': { desc: '여성', type: 'boolean', example: 'WHERE fi_npay_genderf = true' },
                'fi_npay_genderm': { desc: '남성', type: 'boolean', example: 'WHERE fi_npay_genderm = true' },
                'fi_npay_membershipnormal': { desc: '플러스멤버십 가입', type: 'boolean', example: 'WHERE fi_npay_membershipnormal = true' },
                'fi_npay_myassetreg': { desc: '내자산 서비스 연동', type: 'boolean', example: 'WHERE fi_npay_myassetreg = true' },
                'fi_npay_creditcheck': { desc: '신용조회 서비스 가입', type: 'boolean', example: 'WHERE fi_npay_creditcheck = true' },
                'fi_npay_seoul': { desc: '서울특별시 거주', type: 'boolean', example: 'WHERE fi_npay_seoul = true' },
                'fi_npay_gyeonggi': { desc: '경기도 거주', type: 'boolean', example: 'WHERE fi_npay_gyeonggi = true' }
            }
        };
        
        // 팀별 추천 질문
        const TEAM_QUESTIONS = {
            'financial-content': [
                "투자에 관심이 많은 30-40대 고소득층 고객을 찾아줘",
                "자산관리 서비스를 이용할 가능성이 높은 고객 세그먼트는?",
                "금융 교육 컨텐츠에 관심을 보일 만한 고객군 추천해줘",
                "신용점수 향상에 관심이 높은 고객들의 특성을 알려줘",
                "부동산 투자 관련 컨텐츠 타겟 고객을 찾아줘",
                "은퇴 준비에 관심이 있는 50대 이상 고객군은?",
                "주식 투자 경험이 있을 것 같은 고객 프로필을 만들어줘"
            ],
            'member-planning': [
                "신규 가입자 중 장기 이용 가능성이 높은 고객 특성은?",
                "이탈 위험이 높은 고객들의 공통점을 찾아줘",
                "VIP 등급으로 승격시킬 만한 고객들을 추천해줘",
                "멤버십 혜택을 적극 활용하는 고객군의 특징은?",
                "플러스 멤버십 가입 가능성이 높은 고객을 찾아줘",
                "서비스 만족도가 높을 것 같은 고객 세그먼트는?",
                "재방문율이 높은 고객들의 행동 패턴을 알려줘"
            ],
            'myasset': [
                "마이데이터 연동을 수락할 가능성이 높은 고객은?",
                "자산 관리에 적극적인 고객들의 특성을 알려줘",
                "내자산 서비스 신규 이용자로 적합한 고객군은?",
                "다양한 금융기관을 이용하는 고객 프로필을 만들어줘",
                "부동산 자산을 보유한 고객들의 특징은?",
                "투자 상품에 관심이 많은 자산가들을 찾아줘",
                "정기적으로 자산을 점검하는 고객 세그먼트는?"
            ],
            'advertising': [
                "광고 클릭률이 높을 것 같은 고객 세그먼트는?",
                "프리미엄 상품 광고에 반응할 고객군을 찾아줘",
                "모바일 광고에 적극적으로 반응하는 고객 특성은?",
                "계절 상품 광고 타겟으로 적합한 고객들은?",
                "브랜드 충성도가 높은 고객들의 구매 패턴을 알려줘",
                "새로운 서비스 홍보 타겟으로 좋은 고객군은?",
                "소셜 미디어 광고에 반응할 젊은층 고객을 찾아줘"
            ],
            'payment': [
                "결제 패턴이 변화한 고객들의 특징을 알려줘",
                "신규 결제 수단을 시도할 가능성이 높은 고객은?",
                "결제 빈도가 급증한 고객 세그먼트를 찾아줘",
                "특정 업종에서 결제가 활발한 고객군은?",
                "현금 결제에서 카드 결제로 전환한 고객들의 특성은?",
                "온라인 결제를 선호하는 고객들의 연령대별 분포는?",
                "결제 실패율이 낮은 안정적인 고객 그룹을 찾아줘"
            ],
            'loan': [
                "대출 신청 가능성이 높은 고객 세그먼트는?",
                "대환대출 니즈가 있는 고객들을 찾아줘",
                "신용등급 개선에 관심이 높은 고객 특성은?",
                "주택담보대출을 고려할 만한 고객군은?",
                "전세자금대출이 필요한 젊은층 고객을 찾아줘",
                "사업자대출에 관심이 있을 고객 프로필을 만들어줘",
                "기존 대출 고객 중 추가 대출 가능성이 높은 사람들은?"
            ]
        };
        
        let currentThinkingStep = 0;
        let currentFilter = 'all';
        
        // 탭 전환
        function showTab(tabName) {
            // 모든 탭 숨기기
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.nav-tab').forEach(button => {
                button.classList.remove('active');
            });
            
            // 선택된 탭 보이기
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // 컬럼 브라우저 탭이 선택되면 컬럼 로드
            if (tabName === 'column-browser') {
                loadColumns();
            }
        }
        
        // 컬럼 로드
        function loadColumns() {
            const grid = document.getElementById('columnsGrid');
            if (grid.innerHTML.trim() === '') {
                renderColumns();
            }
        }
        
        // 컬럼 렌더링
        function renderColumns() {
            const grid = document.getElementById('columnsGrid');
            grid.innerHTML = '';
            
            Object.entries(FULL_CDP_COLUMNS).forEach(([category, columns]) => {
                if (currentFilter === 'all' || currentFilter === category) {
                    Object.entries(columns).forEach(([columnName, columnInfo]) => {
                        const card = createColumnCard(columnName, columnInfo, category);
                        grid.appendChild(card);
                    });
                }
            });
        }
        
        // 컬럼 카드 생성
        function createColumnCard(columnName, columnInfo, category) {
            const card = document.createElement('div');
            card.className = 'column-card';
            card.innerHTML = `
                <div class="column-name">${columnName}</div>
                <div class="column-type">${columnInfo.type}</div>
                <div class="column-description">${columnInfo.desc}</div>
                <div class="column-example">${columnInfo.example}</div>
            `;
            return card;
        }
        
        // 카테고리별 필터링
        function filterByCategory(category) {
            currentFilter = category;
            
            // 필터 버튼 스타일 업데이트
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderColumns();
        }
        
        // 컬럼 검색
        function filterColumns() {
            const searchTerm = document.getElementById('columnSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.column-card');
            
            cards.forEach(card => {
                const columnName = card.querySelector('.column-name').textContent.toLowerCase();
                const columnDesc = card.querySelector('.column-description').textContent.toLowerCase();
                
                if (columnName.includes(searchTerm) || columnDesc.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // 팀별 추천 질문 표시
        function showTeamQuestions(team) {
            const questionsDiv = document.getElementById('teamQuestions');
            const questions = TEAM_QUESTIONS[team];
            
            questionsDiv.innerHTML = `
                <h4>${getTeamName(team)} 맞춤 추천 질문</h4>
                ${questions.map(question => `
                    <div class="question-item" onclick="useQuestion('${question}')">
                        ${question}
                    </div>
                `).join('')}
            `;
            
            questionsDiv.classList.add('show');
        }
        
        // 팀명 반환
        function getTeamName(team) {
            const teamNames = {
                'financial-content': '💰 정선영님 (금융 컨텐츠)',
                'member-planning': '👥 박지영님 (회원 플래닝)',
                'myasset': '🏦 김정희님 (내자산 플래닝)',
                'advertising': '📢 고시현님 (AD 서비스)',
                'payment': '💳 최동주님 (결제 데이터)',
                'loan': '🏠 이승한님 (대출 서비스)'
            };
            return teamNames[team];
        }
        
        // 추천 질문 사용
        function useQuestion(question) {
            // 쿼리 분석기 탭으로 이동
            showTab('query-analyzer');
            document.querySelector('.nav-tab').click();
            
            // 질문 입력
            document.getElementById('queryInput').value = question;
            
            // 자동 실행
            setTimeout(() => {
                processQuery();
            }, 500);
        }
        
        // AI 사고 과정 시뮬레이션
        function startThinkingProcess() {
            currentThinkingStep = 0;
            document.getElementById('thinkingProcess').classList.add('show');
            
            // 모든 단계 초기화
            document.querySelectorAll('.thinking-step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
            });
            
            // 단계별 진행
            const steps = document.querySelectorAll('.thinking-step');
            
            function nextStep() {
                if (currentThinkingStep > 0) {
                    steps[currentThinkingStep - 1].classList.remove('active');
                    steps[currentThinkingStep - 1].classList.add('completed');
                }
                
                if (currentThinkingStep < steps.length) {
                    steps[currentThinkingStep].classList.add('active');
                    currentThinkingStep++;
                    setTimeout(nextStep, 1500); // 각 단계마다 1.5초
                } else {
                    // 모든 단계 완료 - 결과 표시가 시작될 때까지 보이게 두기
                    // displayResultsProgressively에서 숭김 처리
                }
            }
            
            nextStep();
        }
        
        // 키 입력 처리
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                processQuery();
            }
        }
        
        // 디버그 정보 표시 (숨김 처리)
        function showDebugInfo(message, type = 'debug') {
            // 디버그 정보는 개발자 콘솔에만 표시
            if (type === 'error') {
                console.error('🚨 Error:', message);
            } else if (type === 'success') {
                console.log('✅ Success:', message);
            } else {
                console.log('🐛 Debug:', message);
            }
        }
        
        // 쿼리 처리 (수정된 버전)
        async function processQuery() {
            const query = document.getElementById('queryInput').value.trim();
            
            if (!query) {
                alert('질문을 입력해주세요.');
                return;
            }
            
            // 로딩 및 사고 과정 시작
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('analysisResults').innerHTML = '';
            document.getElementById('debugInfo').innerHTML = '';
            
            showDebugInfo('분석 시작: ' + query);
            startThinkingProcess();
            
            try {
                // 실제 OpenAI API 호출
                showDebugInfo('OpenAI API 호출 중...');
                const result = await analyzeQueryWithAI(query);
                showDebugInfo('API 응답 받음, 결과 표시 중...', 'success');
                displayResultsProgressively(result);
            } catch (error) {
                console.error('Error:', error);
                showDebugInfo('API 오류 발생: ' + error.message, 'error');
                
                // 폴백으로 더미 데이터 사용
                showDebugInfo('폴백 데이터 사용 중...');
                const fallbackResult = generateFallbackResult(query);
                displayResultsProgressively(fallbackResult);
            } finally {
                document.getElementById('loadingSection').style.display = 'none';
            }
        }
        
        // 서버 API 호출로 변경 (보안 개선)
        async function analyzeQueryWithAI(userQuery) {
            showDebugInfo('서버 API 호출 준비...');
            
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: userQuery })
                });
                
                showDebugInfo(`서버 응답 상태: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    showDebugInfo(`서버 오류: ${errorText}`, 'error');
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                showDebugInfo('서버 응답 성공', 'success');
                return result;
                
            } catch (error) {
                showDebugInfo(`API 호출 오류: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // 분석 프롬프트 생성
        function createAnalysisPrompt(query) {
            return `
사용자 질문: "${query}"

위 질문을 분석하여 다음을 제공해주세요:

1. 질문의 핵심 요구사항 분석
2. 타겟 고객군을 정의하기 위한 최적의 CDP 컬럼 조합 추천
3. 각 컬럼을 선택한 이유와 추천 조건값
4. 실행 가능한 SQL 쿼리
5. 비즈니스 인사이트 및 마케팅 활용 방안

CDP 데이터의 특성:
- fa_int_*: 관심사 기반 행동 지표 (date 타입, 이벤트 발생일)
- fa_ind_*: 업종별 결제 지표 (date 타입, 결제일)
- sc_*: AI 예측 스코어 (0-1 범위의 double 타입)
- fi_npay_*: 플래그 지표 (boolean 타입)
            `;
        }
        
        // 폴백 결과 생성 (API 실패 시)
        function generateFallbackResult(query) {
            showDebugInfo('폴백 데이터 생성 중...');
            
            const loanKeywords = ['대출', '빌려', '신용', '금융', '돈'];
            const beautyKeywords = ['뷰티', '화장품', '미용', '코스메틱'];
            const travelKeywords = ['여행', '해외', '항공', '호텔'];
            
            let targetType = '일반';
            if (loanKeywords.some(keyword => query.includes(keyword))) {
                targetType = '대출';
            } else if (beautyKeywords.some(keyword => query.includes(keyword))) {
                targetType = '뷰티';
            } else if (travelKeywords.some(keyword => query.includes(keyword))) {
                targetType = '여행';
            }
            
            showDebugInfo(`타겟 타입 결정: ${targetType}`);
            return generateTargetRecommendation(targetType, query);
        }
        
        // 타겟별 추천 생성
        function generateTargetRecommendation(targetType, originalQuery) {
            const recommendations = {
                '대출': {
                    query_analysis: `"${originalQuery}" - 사용자가 대출 상품에 관심이 높고 신청 가능성이 있는 고객군을 요청했습니다.`,
                    target_description: '신용도가 양호하고 안정적인 소득을 보유하여 대출 상품 이용 가능성이 높은 고객군',
                    recommended_columns: [
                        {
                            column: 'sc_int_loan1stfinancial',
                            description: '1금융권 신용대출 예측스코어',
                            condition: '> 0.7',
                            priority: 'high',
                            reasoning: '1금융권에서 대출받을 가능성이 높아 안정적인 고객층으로 판단됩니다.'
                        },
                        {
                            column: 'fa_int_loanpersonal',
                            description: '최근 신용대출 실행 이력',
                            condition: 'IS NOT NULL',
                            priority: 'high',
                            reasoning: '기존 대출 경험이 있어 대출 상품에 대한 이해도가 높고 추가 니즈가 있을 가능성이 큽니다.'
                        },
                        {
                            column: 'fi_npay_creditcheck',
                            description: '신용조회 서비스 가입 여부',
                            condition: '= true',
                            priority: 'medium',
                            reasoning: '신용관리에 관심이 높아 대출 상품 정보에도 적극적으로 반응할 것으로 예상됩니다.'
                        },
                        {
                            column: 'sc_int_highincome',
                            description: '고소득 예측스코어',
                            condition: '> 0.6',
                            priority: 'medium',
                            reasoning: '안정적인 소득 기반으로 대출 상환 능력이 검증된 우량 고객입니다.'
                        }
                    ],
                    sql_query: `SELECT mbr_id_no, 
       sc_int_loan1stfinancial,
       fa_int_loanpersonal,
       fi_npay_creditcheck,
       sc_int_highincome
FROM cdp_customer_data 
WHERE (sc_int_loan1stfinancial > 0.7)
   OR (fa_int_loanpersonal IS NOT NULL AND fi_npay_creditcheck = true)
   OR (sc_int_highincome > 0.6 AND fi_npay_creditcheck = true)
ORDER BY sc_int_loan1stfinancial DESC, sc_int_highincome DESC;`,
                    business_insights: [
                        '고소득층일수록 대출 한도가 높아 수익성 관점에서 우선 타겟팅 필요',
                        '기존 대출 고객의 대환대출 니즈를 적극 발굴하여 고객 유지 및 수익 증대 가능',
                        '신용조회 서비스 이용자는 금융 상품 관심도가 높아 마케팅 효과가 좋음',
                        '1금융권 대출 가능 고객은 신용도가 우수하여 연체 위험이 낮음'
                    ],
                    estimated_target_size: '15-20%',
                    marketing_recommendations: [
                        '개인별 신용점수를 활용한 맞춤형 대출 상품 및 금리 제안',
                        '기존 대출 고객 대상 대환대출 상담 및 우대 조건 제공',
                        '신용조회 서비스 내에서 대출 상품 정보 자연스럽게 노출',
                        '고소득층 대상 프리미엄 대출 상품 및 전용 상담 서비스 제공'
                    ]
                },
                '뷰티': {
                    query_analysis: `"${originalQuery}" - 뷰티 및 화장품 구매에 적극적이고 관련 소비가 활발한 고객군을 요청했습니다.`,
                    target_description: '뷰티 트렌드에 민감하고 관련 제품 구매 및 서비스 이용이 활발한 고객군',
                    recommended_columns: [
                        {
                            column: 'sc_ind_cosmetic',
                            description: '뷰티 제품 결제 예측스코어',
                            condition: '> 0.8',
                            priority: 'high',
                            reasoning: '뷰티 제품 구매 가능성이 매우 높은 핵심 타겟층으로 우선 공략 필요합니다.'
                        },
                        {
                            column: 'fa_ind_beauty',
                            description: '미용 서비스 결제 이력',
                            condition: 'IS NOT NULL',
                            priority: 'high',
                            reasoning: '미용실, 네일샵 등 뷰티 서비스 이용으로 뷰티에 대한 관심도가 확인된 고객입니다.'
                        },
                        {
                            column: 'fi_npay_genderf',
                            description: '여성 고객',
                            condition: '= true',
                            priority: 'medium',
                            reasoning: '뷰티 제품의 주요 구매층인 여성 고객을 우선 타겟팅해야 합니다.'
                        },
                        {
                            column: 'fi_npay_age20',
                            description: '20대 연령층',
                            condition: '= true',
                            priority: 'medium',
                            reasoning: '뷰티 트렌드에 가장 민감하고 새로운 제품 시도 의향이 높은 연령층입니다.'
                        }
                    ],
                    sql_query: `SELECT mbr_id_no,
       sc_ind_cosmetic,
       fa_ind_beauty,
       fi_npay_genderf,
       fi_npay_age20
FROM cdp_customer_data
WHERE (sc_ind_cosmetic > 0.8)
   OR (fa_ind_beauty IS NOT NULL AND fi_npay_genderf = true)
   OR (fi_npay_genderf = true AND fi_npay_age20 = true AND sc_ind_cosmetic > 0.5)
ORDER BY sc_ind_cosmetic DESC;`,
                    business_insights: [
                        '젊은 여성층의 뷰티 지출이 지속적으로 증가하는 트렌드',
                        '미용 서비스와 뷰티 제품을 함께 이용하는 고객의 생애가치(LTV)가 높음',
                        '온라인 뷰티 커머스 시장 급성장으로 디지털 마케팅 기회 확대',
                        '개인화된 뷰티 솔루션에 대한 수요 증가'
                    ],
                    estimated_target_size: '25-30%',
                    marketing_recommendations: [
                        '뷰티 인플루언서 및 소셜미디어를 활용한 제품 체험 마케팅',
                        '개인 피부타입 및 선호도 기반 맞춤형 뷰티 루틴 제안',
                        '미용실 방문 고객 대상 뷰티 제품 할인 쿠폰 제공',
                        '계절별 뷰티 트렌드 정보와 연계한 신제품 출시 알림'
                    ]
                },
                '여행': {
                    query_analysis: `"${originalQuery}" - 여행을 자주 다니며 여행 관련 상품 및 서비스 이용이 활발한 고객군을 요청했습니다.`,
                    target_description: '국내외 여행 경험이 풍부하고 여행 관련 지출이 활발한 고객군',
                    recommended_columns: [
                        {
                            column: 'fa_int_traveloverseas',
                            description: '해외여행 예정 고객',
                            condition: 'IS NOT NULL',
                            priority: 'high',
                            reasoning: '해외여행 계획이 확정된 고객으로 여행 관련 상품 구매 확률이 매우 높습니다.'
                        },
                        {
                            column: 'fa_ind_travel',
                            description: '여행 관련 결제 이력',
                            condition: 'IS NOT NULL',
                            priority: 'high',
                            reasoning: '여행사, 항공권 등 여행 상품 구매 경험이 있어 재구매 가능성이 높습니다.'
                        },
                        {
                            column: 'fa_ind_airsevice',
                            description: '항공 서비스 이용',
                            condition: 'IS NOT NULL',
                            priority: 'medium',
                            reasoning: '항공편 이용 경험으로 중장거리 여행을 선호하는 고객임을 확인할 수 있습니다.'
                        },
                        {
                            column: 'sc_int_highincome',
                            description: '고소득 예측스코어',
                            condition: '> 0.6',
                            priority: 'medium',
                            reasoning: '여행에 충분한 지출이 가능한 경제적 여력을 보유한 고객입니다.'
                        }
                    ],
                    sql_query: `SELECT mbr_id_no,
       fa_int_traveloverseas,
       fa_ind_travel,
       fa_ind_airsevice,
       sc_int_highincome
FROM cdp_customer_data
WHERE (fa_int_traveloverseas IS NOT NULL)
   OR (fa_ind_travel IS NOT NULL AND sc_int_highincome > 0.6)
   OR (fa_ind_airsevice IS NOT NULL AND fa_ind_travel IS NOT NULL)
ORDER BY sc_int_highincome DESC;`,
                    business_insights: [
                        '포스트 코로나 시대 해외여행 수요가 급격히 회복되는 추세',
                        '고소득층일수록 프리미엄 여행 상품 및 부가 서비스를 선호',
                        '여행자보험, 환전, 여행용품 등 부가 서비스 동반 수요 증가',
                        '개인 맞춤형 여행 패키지에 대한 관심도 상승'
                    ],
                    estimated_target_size: '12-18%',
                    marketing_recommendations: [
                        '시즌별 인기 여행지 및 패키지 상품 맞춤 추천',
                        '여행자보험 상품과 여행 패키지 번들 마케팅',
                        '항공마일리지 적립 및 여행 혜택 강화 프로그램',
                        '여행 관련 금융 상품(여행적금, 환전 서비스) 연계 제안'
                    ]
                }
            };
            
            return recommendations[targetType] || {
                query_analysis: `"${originalQuery}"에 대한 분석을 수행했습니다.`,
                target_description: '요청하신 조건에 맞는 고객군',
                recommended_columns: [],
                sql_query: 'SELECT * FROM cdp_customer_data LIMIT 100;',
                business_insights: ['추가 분석이 필요합니다.'],
                estimated_target_size: '10-15%',
                marketing_recommendations: ['맞춤형 마케팅 전략을 수립해보세요.']
            };
        }
        
        // 분석 방법 배너 생성
        function createAnalysisMethodBanner(metadata) {
            if (!metadata) {
                return '<div class="debug-info">분석 방법 정보가 없습니다.</div>';
            }
            
            const { analysisMethod, processingTimeMs, timestamp } = metadata;
            
            let bannerClass, icon, title, description;
            
            switch (analysisMethod) {
                case 'openai':
                    bannerClass = 'success-info';
                    icon = '🤖';
                    title = 'AI 분석 완료';
                    description = `OpenAI GPT 모델이 실시간으로 분석했습니다 (${processingTimeMs}ms)`;
                    break;
                case 'fallback_after_error':
                    bannerClass = 'error-info';
                    icon = '⚠️';
                    title = 'AI 분석 실패 - 대체 분석 사용';
                    description = `OpenAI API 오류로 인해 키워드 기반 분석으로 전환했습니다 (${processingTimeMs}ms)`;
                    break;
                case 'fallback_no_key':
                    bannerClass = 'debug-info';
                    icon = '🔑';
                    title = '키워드 기반 분석';
                    description = `OpenAI API 키가 설정되지 않아 키워드 기반 분석을 사용했습니다 (${processingTimeMs}ms)`;
                    break;
                default:
                    bannerClass = 'debug-info';
                    icon = '❓';
                    title = '분석 방법 불명';
                    description = `분석이 완료되었습니다 (${processingTimeMs}ms)`;
            }
            
            return `
                <div class="${bannerClass}" style="margin-bottom: 20px; border-radius: 10px; animation: slideDown 0.5s ease;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.2em;">${icon}</span>
                        <div>
                            <strong>${title}</strong><br>
                            <small>${description}</small><br>
                            <small style="opacity: 0.7;">분석 시각: ${new Date(timestamp).toLocaleString('ko-KR')}</small>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 단계별 결과 표시
        function displayResultsProgressively(result) {
            // thinking process 숭기기
            setTimeout(() => {
                document.getElementById('thinkingProcess').style.display = 'none';
            }, 500);
            
            const resultsDiv = document.getElementById('analysisResults');
            resultsDiv.innerHTML = ''; // 초기화
            
            // 분석 방법 표시 배너 추가
            const methodBanner = createAnalysisMethodBanner(result._metadata);
            resultsDiv.innerHTML = methodBanner;
            
            const steps = [
                {
                    title: '🎯 질문 분석 결과',
                    content: `<div class="analysis-result step-result" style="opacity: 0; transform: translateY(20px);">
                        <h3>🎯 질문 분석 결과</h3>
                        <p>${result.query_analysis}</p>
                    </div>`
                },
                {
                    title: '👥 타겟 고객군 정의',
                    content: `<div class="analysis-result step-result" style="opacity: 0; transform: translateY(20px);">
                        <h3>👥 타겟 고객군 정의</h3>
                        <p>${result.target_description}</p>
                        <div class="stats-section" style="margin-top: 20px;">
                            <div class="stat-card">
                                <div class="stat-number">${result.recommended_columns.length}</div>
                                <div class="stat-label">추천 컬럼 수</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${result.estimated_target_size}</div>
                                <div class="stat-label">예상 타겟 규모</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${result.marketing_recommendations.length}</div>
                                <div class="stat-label">마케팅 제안</div>
                            </div>
                        </div>
                    </div>`
                },
                {
                    title: '📊 추천 CDP 컬럼 조합',
                    content: `<div class="analysis-result step-result" style="opacity: 0; transform: translateY(20px);">
                        <h3>📊 추천 CDP 컬럼 조합</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;">
                            ${generateColumnRecommendations(result.recommended_columns)}
                        </div>
                    </div>`
                },
                {
                    title: '🧠 AI 분석 근거',
                    content: `<div class="step-result" style="opacity: 0; transform: translateY(20px); background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%); color: white; padding: 25px; border-radius: 15px; margin: 20px 0;">
                        <h4>🧠 AI 분석 근거</h4>
                        ${result.recommended_columns.map(col => `
                            <div style="background: rgba(255, 255, 255, 0.1); padding: 12px 15px; margin: 10px 0; border-radius: 8px; border-left: 3px solid rgba(255, 255, 255, 0.3);">
                                <strong>${col.column}:</strong> ${col.reasoning}
                            </div>
                        `).join('')}
                    </div>`
                },
                {
                    title: '📝 실행 가능한 SQL 쿼리',
                    content: `<div class="step-result" style="opacity: 0; transform: translateY(20px); background: #2c3e50; color: white; padding: 25px; border-radius: 15px; margin: 20px 0;">
                        <h4>📝 실행 가능한 SQL 쿼리</h4>
                        <div style="background: #34495e; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 14px; overflow-x: auto; white-space: pre-wrap;">${result.sql_query}</div>
                        <button style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-size: 12px;" onclick="copyToClipboard(\`${result.sql_query.replace(/`/g, '\\`')}\`)">
                            📋 쿼리 복사
                        </button>
                    </div>`
                },
                {
                    title: '💡 비즈니스 인사이트 & 마케팅 활용방안',
                    content: `<div class="analysis-result step-result" style="opacity: 0; transform: translateY(20px);">
                        <h3>💡 비즈니스 인사이트</h3>
                        ${result.business_insights.map(insight => `<p>• ${insight}</p>`).join('')}
                    </div>
                    <div class="analysis-result step-result" style="opacity: 0; transform: translateY(20px); margin-top: 20px;">
                        <h3>🚀 마케팅 활용 방안</h3>
                        ${result.marketing_recommendations.map(rec => `<p>• ${rec}</p>`).join('')}
                    </div>`
                }
            ];
            
            // 각 단계를 순차적으로 표시
            let currentStep = 0;
            
            function showNextStep() {
                if (currentStep < steps.length) {
                    // 다음 단계 추가
                    resultsDiv.innerHTML += steps[currentStep].content;
                    
                    // 방금 추가된 요소들에 애니메이션 적용
                    const newElements = resultsDiv.querySelectorAll('.step-result');
                    const latestElements = Array.from(newElements).slice(-1); // 마지막 요소만
                    
                    if (steps[currentStep].title === '💡 비즈니스 인사이트 & 마케팅 활용방안') {
                        // 마지막 단계는 두 개의 요소가 있음
                        const lastTwoElements = Array.from(newElements).slice(-2);
                        lastTwoElements.forEach(element => {
                            setTimeout(() => {
                                element.style.transition = 'all 0.8s ease-out';
                                element.style.opacity = '1';
                                element.style.transform = 'translateY(0)';
                            }, 100);
                        });
                    } else {
                        latestElements.forEach(element => {
                            setTimeout(() => {
                                element.style.transition = 'all 0.8s ease-out';
                                element.style.opacity = '1';
                                element.style.transform = 'translateY(0)';
                            }, 100);
                        });
                    }
                    
                    currentStep++;
                    
                    // 다음 단계를 1.5초 후에 표시
                    setTimeout(showNextStep, 1500);
                } else {
                    // 모든 단계 완료
                    showDebugInfo('모든 결과 표시 완료', 'success');
                }
            }
            
            // 첫 단계 시작
            showNextStep();
        }
        
        // 컬럼 추천 HTML 생성
        function generateColumnRecommendations(columns) {
            const grouped = {
                high: columns.filter(c => c.priority === 'high'),
                medium: columns.filter(c => c.priority === 'medium'),
                low: columns.filter(c => c.priority === 'low')
            };
            
            return Object.entries(grouped).map(([priority, cols]) => {
                if (cols.length === 0) return '';
                
                const priorityLabels = {
                    high: '🔥 핵심 지표',
                    medium: '⭐ 보조 지표',
                    low: '💡 참고 지표'
                };
                
                return `
                    <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e9ecef;">
                        <h4 style="color: #495057; margin-bottom: 15px; font-size: 1.1em;">${priorityLabels[priority]}</h4>
                        ${cols.map(col => `
                            <div style="background: #f8f9fa; padding: 10px 15px; margin: 8px 0; border-radius: 8px; border-left: 3px solid #4CAF50;">
                                <div style="font-weight: 500; color: #2c3e50;">${col.column}</div>
                                <div style="font-size: 0.9em; color: #6c757d; margin-top: 2px;">${col.description}</div>
                                <div style="font-size: 0.8em; color: #4CAF50; margin-top: 2px;">조건: ${col.condition}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }
        
        // 에러 표시
        function displayError(message) {
            const resultsDiv = document.getElementById('analysisResults');
            resultsDiv.innerHTML = `
                <div class="analysis-result" style="border-left-color: #dc3545;">
                    <h3 style="color: #dc3545;">⚠️ 오류 발생</h3>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // 클립보드 복사
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('쿼리가 클립보드에 복사되었습니다!');
            });
        }
        
        // 서버 상태 확인
        async function checkServerStatus() {
            try {
                showDebugInfo('서버 상태 확인 중...', 'debug');
                
                const response = await fetch('/api/debug');
                const data = await response.json();
                
                let statusMessage = `🖥️ 서버 상태 정보\n\n`;
                statusMessage += `⏰ 시간: ${new Date(data.timestamp).toLocaleString('ko-KR')}\n`;
                statusMessage += `🌍 환경: ${data.environment}\n`;
                statusMessage += `🔑 OpenAI API 키: ${data.hasOpenAIKey ? '✅ 설정됨' : '❌ 없음'}\n`;
                
                if (data.hasOpenAIKey) {
                    statusMessage += `📏 API 키 길이: ${data.apiKeyLength}자\n`;
                    statusMessage += `🔤 API 키 시작: ${data.apiKeyPrefix}\n`;
                } else {
                    statusMessage += `⚠️ Railway에서 OPENAI_API_KEY 환경변수를 설정해주세요.\n`;
                }
                
                statusMessage += `🚀 서버: ${data.serverStatus}`;
                
                alert(statusMessage);
                showDebugInfo('서버 상태 확인 완료', 'success');
                
            } catch (error) {
                console.error('서버 상태 확인 오류:', error);
                showDebugInfo(`서버 상태 확인 실패: ${error.message}`, 'error');
                alert(`❌ 서버 상태 확인 실패\n\n${error.message}`);
            }
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Working CDP AI 자연어 쿼리 플랫폼이 로드되었습니다.');
            document.getElementById('queryInput').focus();
        });
    </script>
</body>
</html>